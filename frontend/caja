<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Caja - Servicios de Aire Acondicionado</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            margin-left: 10px;
            font-size: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .service-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .service-item {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .service-item:hover {
            background-color: #f9f9f9;
        }
        
        .service-item.selected {
            border-color: var(--secondary-color);
            background-color: #e8f4fd;
        }
        
        .service-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-in-progress {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-finalized {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .quote-details, .invoice-details {
            margin-top: 20px;
        }
        
        .quote-items, .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .quote-items th, .invoice-items th {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .quote-items td, .invoice-items td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .totals {
            text-align: right;
            margin-top: 15px;
            font-weight: 600;
        }
        
        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom-color: var(--secondary-color);
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .hidden {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-section {
                display: block !important;
            }
        }
        
        .print-section {
            display: none;
        }
        
        .payment-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>Sistema de Caja - Servicios de Aire Acondicionado</h1>
                
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs no-print">
            <div class="tab active" data-tab="services">Servicios</div>
            <div class="tab" data-tab="quotes">Cotizaciones</div>
            <div class="tab" data-tab="invoices">Facturas</div>
            <div class="tab" data-tab="payment">Cobro</div>
        </div>
        
        <!-- Pestaña de Servicios -->
        <div class="tab-content active" id="services-tab">
            <div class="main-content">
                <div class="left-panel">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Lista de Servicios</h2>
                        </div>
                        <div class="service-list" id="serviceList">
                            <!-- Los servicios se cargarán dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Detalles del Servicio</h2>
                        </div>
                        <div id="serviceDetails">
                            <p>Seleccione un servicio para ver los detalles</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Acciones</h2>
                        </div>
                        <div class="actions">
                            <button class="btn btn-primary" id="generateQuoteBtn" disabled>Generar Cotización</button>
                            <button class="btn btn-success" id="generateInvoiceBtn" disabled>Generar Factura</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Cotizaciones -->
        <div class="tab-content" id="quotes-tab">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Generar Cotización</h2>
                </div>
                <div id="quoteForm">
                    <div class="alert alert-warning" id="quoteAlert">
                        No se puede generar cotización sin cliente ni vehículo asociado. No más de una cotización activa por servicio.
                    </div>
                    
                    <div class="form-group">
                        <label for="quoteService">Servicio:</label>
                        <select id="quoteService" required>
                            <option value="">Seleccione un servicio</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quoteClient">Cliente:</label>
                        <input type="text" id="quoteClient" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="quoteVehicle">Vehículo:</label>
                        <input type="text" id="quoteVehicle" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="quoteDescription">Descripción del Servicio:</label>
                        <textarea id="quoteDescription" rows="3" readonly></textarea>
                    </div>
                    
                    <div class="quote-details">
                        <h3>Detalles de la Cotización</h3>
                        <table class="quote-items">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="quoteItems">
                                <!-- Los ítems se agregarán dinámicamente -->
                            </tbody>
                        </table>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="addQuoteItem">Agregar Ítem</button>
                        </div>
                        
                        <div class="totals">
                            <p>Subtotal: $<span id="quoteSubtotal">0.00</span></p>
                            <p>IVA (16%): $<span id="quoteTax">0.00</span></p>
                            <p>Total: $<span id="quoteTotal">0.00</span></p>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" id="saveQuoteBtn">Guardar Cotización</button>
                        <button class="btn btn-success" id="printQuoteBtn" disabled>Imprimir Cotización</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Facturas -->
        <div class="tab-content" id="invoices-tab">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Generar Factura</h2>
                </div>
                <div id="invoiceForm">
                    <div class="alert alert-warning" id="invoiceAlert">
                        Solo facturar servicios 'Finalizados'. Pagos deben coincidir con monto total.
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceService">Servicio:</label>
                        <select id="invoiceService" required>
                            <option value="">Seleccione un servicio finalizado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceClient">Cliente:</label>
                        <input type="text" id="invoiceClient" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceVehicle">Vehículo:</label>
                        <input type="text" id="invoiceVehicle" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDescription">Descripción del Servicio:</label>
                        <textarea id="invoiceDescription" rows="3" readonly></textarea>
                    </div>
                    
                    <div class="invoice-details">
                        <h3>Detalles de la Factura</h3>
                        <table class="invoice-items">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                                <!-- Los ítems se cargarán dinámicamente -->
                            </tbody>
                        </table>
                        
                        <div class="totals">
                            <p>Subtotal: $<span id="invoiceSubtotal">0.00</span></p>
                            <p>IVA (16%): $<span id="invoiceTax">0.00</span></p>
                            <p>Total: $<span id="invoiceTotal">0.00</span></p>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" id="saveInvoiceBtn">Guardar Factura</button>
                        <button class="btn btn-success" id="processPaymentBtn" disabled>Procesar Pago</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestaña de Cobro -->
        <div class="tab-content" id="payment-tab">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Procesar Pago</h2>
                </div>
                <div id="paymentForm">
                    <div class="alert alert-warning" id="paymentAlert">
                        Verificar estado y método de pago válido. Pagos deben coincidir con monto total.
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentInvoice">Factura:</label>
                        <select id="paymentInvoice" required>
                            <option value="">Seleccione una factura pendiente de pago</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentClient">Cliente:</label>
                        <input type="text" id="paymentClient" required readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentVehicle">Vehículo:</label>
                        <input type="text" id="paymentVehicle" required readonly>
                    </div>
                    
                    <div class="payment-section">
                        <h3>Detalles del Pago</h3>
                        
                        <div class="form-group">
                            <label for="paymentTotal">Total a Pagar:</label>
                            <input type="number" id="paymentTotal" min="0" step="0.01" required readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentMethod">Método de Pago:</label>
                            <select id="paymentMethod" required>
                                <option value="">Seleccione método de pago</option>
                                <option value="cash">Efectivo</option>
                                <option value="card">Tarjeta</option>
                                <option value="transfer">Transferencia</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentAmount">Monto Pagado:</label>
                            <input type="number" id="paymentAmount" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="paymentChange">Cambio:</label>
                            <input type="number" id="paymentChange" min="0" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success" id="confirmPaymentBtn" disabled>Confirmar Pago</button>
                        <button class="btn btn-warning" id="printReceiptBtn" disabled>Imprimir Recibo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección para impresión de tickets -->
    <div class="print-section" id="printQuote">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>COTIZACIÓN</h2>
            <p>Servicios de Aire Acondicionado</p>
        </div>
        <div id="printQuoteContent">
            <!-- Contenido de la cotización para imprimir -->
        </div>
        <div style="margin-top: 30px; text-align: center;">
            <p>Gracias por su preferencia</p>
        </div>
    </div>
    
    <div class="print-section" id="printInvoice">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>FACTURA</h2>
            <p>Servicios de Aire Acondicionado</p>
        </div>
        <div id="printInvoiceContent">
            <!-- Contenido de la factura para imprimir -->
        </div>
        <div style="margin-top: 30px; text-align: center;">
            <p>Gracias por su preferencia</p>
        </div>
    </div>
    
    <div class="print-section" id="printReceipt">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2>RECIBO DE PAGO</h2>
            <p>Servicios de Aire Acondicionado</p>
        </div>
        <div id="printReceiptContent">
            <!-- Contenido del recibo para imprimir -->
        </div>
        <div style="margin-top: 30px; text-align: center;">
            <p>Gracias por su preferencia</p>
        </div>
    </div>

    <script>
        // Datos de ejemplo para simular servicios
        const services = [
            {
                id: 1,
                client: "Juan Pérez",
                vehicle: "Toyota Corolla 2020",
                description: "Mantenimiento preventivo de aire acondicionado",
                status: "pending",
                quote: null,
                invoice: null
            },
            {
                id: 2,
                client: "María García",
                vehicle: "Honda Civic 2019",
                description: "Reparación de compresor",
                status: "in-progress",
                quote: {
                    id: "QT001",
                    items: [
                        { description: "Compresor nuevo", quantity: 1, price: 350.00 },
                        { description: "Mano de obra", quantity: 3, price: 50.00 }
                    ],
                    subtotal: 500.00,
                    tax: 80.00,
                    total: 580.00
                },
                invoice: null
            },
            {
                id: 3,
                client: "Carlos López",
                vehicle: "Nissan Sentra 2021",
                description: "Limpieza de sistema y recarga de gas",
                status: "completed",
                quote: {
                    id: "QT002",
                    items: [
                        { description: "Gas refrigerante", quantity: 2, price: 45.00 },
                        { description: "Mano de obra", quantity: 2, price: 50.00 }
                    ],
                    subtotal: 190.00,
                    tax: 30.40,
                    total: 220.40
                },
                invoice: null
            },
            {
                id: 4,
                client: "Ana Rodríguez",
                vehicle: "Ford Focus 2018",
                description: "Cambio de filtro y limpieza completa",
                status: "finalized",
                quote: {
                    id: "QT003",
                    items: [
                        { description: "Filtro de aire", quantity: 1, price: 25.00 },
                        { description: "Mano de obra", quantity: 1, price: 50.00 }
                    ],
                    subtotal: 75.00,
                    tax: 12.00,
                    total: 87.00
                },
                invoice: {
                    id: "INV001",
                    items: [
                        { description: "Filtro de aire", quantity: 1, price: 25.00 },
                        { description: "Mano de obra", quantity: 1, price: 50.00 }
                    ],
                    subtotal: 75.00,
                    tax: 12.00,
                    total: 87.00,
                    paymentMethod: null,
                    paymentAmount: null,
                    paid: false
                }
            }
        ];

        // Variables globales
        let selectedService = null;
        let currentQuote = null;
        let currentInvoice = null;
        let currentPayment = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadServices();
            setupEventListeners();
            updateQuoteServiceDropdown();
            updateInvoiceServiceDropdown();
            updatePaymentInvoiceDropdown();
            
            // Cargar datos de usuario desde localStorage (simulado)
            const userData = localStorage.getItem('userData');
            if (userData) {
                const user = JSON.parse(userData);
                document.getElementById('userName').textContent = `Usuario: ${user.name}`;
            }
        });

        // Cargar lista de servicios
        function loadServices() {
            const serviceList = document.getElementById('serviceList');
            serviceList.innerHTML = '';
            
            services.forEach(service => {
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.dataset.id = service.id;
                
                let statusText = '';
                let statusClass = '';
                
                switch(service.status) {
                    case 'pending':
                        statusText = 'Pendiente';
                        statusClass = 'status-pending';
                        break;
                    case 'in-progress':
                        statusText = 'En Progreso';
                        statusClass = 'status-in-progress';
                        break;
                    case 'completed':
                        statusText = 'Completado';
                        statusClass = 'status-completed';
                        break;
                    case 'finalized':
                        statusText = 'Finalizado';
                        statusClass = 'status-finalized';
                        break;
                }
                
                serviceItem.innerHTML = `
                    <h3>${service.client}</h3>
                    <p><strong>Vehículo:</strong> ${service.vehicle}</p>
                    <p><strong>Servicio:</strong> ${service.description}</p>
                    <span class="service-status ${statusClass}">${statusText}</span>
                `;
                
                serviceItem.addEventListener('click', () => selectService(service.id));
                serviceList.appendChild(serviceItem);
            });
        }

        // Seleccionar servicio
        function selectService(serviceId) {
            // Remover selección anterior
            document.querySelectorAll('.service-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Marcar como seleccionado
            document.querySelector(`.service-item[data-id="${serviceId}"]`).classList.add('selected');
            
            // Obtener datos del servicio
            selectedService = services.find(s => s.id === serviceId);
            
            
            showServiceDetails(selectedService);
            
            
            const generateQuoteBtn = document.getElementById('generateQuoteBtn');
            const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');
            
            generateQuoteBtn.disabled = false;
            
            
            generateInvoiceBtn.disabled = selectedService.status !== 'finalized';
        }

        
        function showServiceDetails(service) {
            const serviceDetails = document.getElementById('serviceDetails');
            
            let quoteInfo = '';
            if (service.quote) {
                quoteInfo = `
                    <p><strong>Cotización:</strong> ${service.quote.id}</p>
                    <p><strong>Total Cotización:</strong> $${service.quote.total.toFixed(2)}</p>
                `;
            } else {
                quoteInfo = '<p><strong>Cotización:</strong> No generada</p>';
            }
            
            let invoiceInfo = '';
            if (service.invoice) {
                invoiceInfo = `
                    <p><strong>Factura:</strong> ${service.invoice.id}</p>
                    <p><strong>Total Factura:</strong> $${service.invoice.total.toFixed(2)}</p>
                    <p><strong>Estado de Pago:</strong> ${service.invoice.paid ? 'Pagado' : 'Pendiente'}</p>
                `;
            } else {
                invoiceInfo = '<p><strong>Factura:</strong> No generada</p>';
            }
            
            serviceDetails.innerHTML = `
                <div class="form-group">
                    <label>Cliente:</label>
                    <p>${service.client}</p>
                </div>
                <div class="form-group">
                    <label>Vehículo:</label>
                    <p>${service.vehicle}</p>
                </div>
                <div class="form-group">
                    <label>Descripción del Servicio:</label>
                    <p>${service.description}</p>
                </div>
                ${quoteInfo}
                ${invoiceInfo}
            `;
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remover clase active de todas las pestañas
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Agregar clase active a la pestaña seleccionada
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // Botones de acción
            document.getElementById('generateQuoteBtn').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="quotes"]').click();
                if (selectedService) {
                    document.getElementById('quoteService').value = selectedService.id;
                    updateQuoteForm();
                }
            });
            
            document.getElementById('generateInvoiceBtn').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="invoices"]').click();
                if (selectedService) {
                    document.getElementById('invoiceService').value = selectedService.id;
                    updateInvoiceForm();
                }
            });
            
            // Cotización
            document.getElementById('quoteService').addEventListener('change', updateQuoteForm);
            document.getElementById('addQuoteItem').addEventListener('click', addQuoteItem);
            document.getElementById('saveQuoteBtn').addEventListener('click', saveQuote);
            document.getElementById('printQuoteBtn').addEventListener('click', printQuote);
            
            // Factura
            document.getElementById('invoiceService').addEventListener('change', updateInvoiceForm);
            document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
            document.getElementById('processPaymentBtn').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="payment"]').click();
                if (currentInvoice) {
                    document.getElementById('paymentInvoice').value = currentInvoice.id;
                    updatePaymentForm();
                }
            });
            
            // Pago
            document.getElementById('paymentInvoice').addEventListener('change', updatePaymentForm);
            document.getElementById('paymentAmount').addEventListener('input', calculateChange);
            document.getElementById('paymentMethod').addEventListener('change', validatePayment);
            document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
            document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);
            
            
            
            
            
        }

        // Actualizar dropdown de servicios para cotización
        function updateQuoteServiceDropdown() {
            const dropdown = document.getElementById('quoteService');
            dropdown.innerHTML = '<option value="">Seleccione un servicio</option>';
            
            services.forEach(service => {
                // Solo mostrar servicios que no tengan cotización activa
                if (!service.quote) {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.client} - ${service.vehicle}`;
                    dropdown.appendChild(option);
                }
            });
        }

        // Actualizar dropdown de servicios para factura
        function updateInvoiceServiceDropdown() {
            const dropdown = document.getElementById('invoiceService');
            dropdown.innerHTML = '<option value="">Seleccione un servicio finalizado</option>';
            
            services.forEach(service => {
                // Solo mostrar servicios finalizados que no tengan factura
                if (service.status === 'finalized' && !service.invoice) {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.client} - ${service.vehicle}`;
                    dropdown.appendChild(option);
                }
            });
        }

        // Actualizar dropdown de facturas para pago
        function updatePaymentInvoiceDropdown() {
            const dropdown = document.getElementById('paymentInvoice');
            dropdown.innerHTML = '<option value="">Seleccione una factura pendiente de pago</option>';
            
            services.forEach(service => {
                // Solo mostrar facturas que no han sido pagadas
                if (service.invoice && !service.invoice.paid) {
                    const option = document.createElement('option');
                    option.value = service.invoice.id;
                    option.textContent = `${service.invoice.id} - ${service.client} - $${service.invoice.total.toFixed(2)}`;
                    dropdown.appendChild(option);
                }
            });
        }

        // Actualizar formulario de cotización
        function updateQuoteForm() {
            const serviceId = document.getElementById('quoteService').value;
            if (!serviceId) {
                resetQuoteForm();
                return;
            }
            
            const service = services.find(s => s.id === parseInt(serviceId));
            if (!service) return;
            
            document.getElementById('quoteClient').value = service.client;
            document.getElementById('quoteVehicle').value = service.vehicle;
            document.getElementById('quoteDescription').value = service.description;
            
            // Si ya existe una cotización, cargarla
            if (service.quote) {
                currentQuote = service.quote;
                loadQuoteItems();
            } else {
                currentQuote = {
                    id: `QT${String(services.filter(s => s.quote).length + 1).padStart(3, '0')}`,
                    items: [],
                    subtotal: 0,
                    tax: 0,
                    total: 0
                };
                document.getElementById('quoteItems').innerHTML = '';
                updateQuoteTotals();
            }
            
            document.getElementById('saveQuoteBtn').disabled = false;
        }

        // Reiniciar formulario de cotización
        function resetQuoteForm() {
            document.getElementById('quoteClient').value = '';
            document.getElementById('quoteVehicle').value = '';
            document.getElementById('quoteDescription').value = '';
            document.getElementById('quoteItems').innerHTML = '';
            document.getElementById('quoteSubtotal').textContent = '0.00';
            document.getElementById('quoteTax').textContent = '0.00';
            document.getElementById('quoteTotal').textContent = '0.00';
            document.getElementById('saveQuoteBtn').disabled = true;
            document.getElementById('printQuoteBtn').disabled = true;
            currentQuote = null;
        }

        // Agregar ítem a cotización
        function addQuoteItem() {
            if (!currentQuote) return;
            
            const itemCount = currentQuote.items.length + 1;
            const newItem = {
                description: `Servicio ${itemCount}`,
                quantity: 1,
                price: 0.00
            };
            
            currentQuote.items.push(newItem);
            loadQuoteItems();
        }

        // Cargar ítems de cotización
        function loadQuoteItems() {
            const itemsContainer = document.getElementById('quoteItems');
            itemsContainer.innerHTML = '';
            
            currentQuote.items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${item.description}" data-index="${index}" data-field="description"></td>
                    <td><input type="number" value="${item.quantity}" min="1" data-index="${index}" data-field="quantity"></td>
                    <td><input type="number" value="${item.price.toFixed(2)}" min="0" step="0.01" data-index="${index}" data-field="price"></td>
                    <td>$<span class="item-subtotal">${(item.quantity * item.price).toFixed(2)}</span></td>
                    <td><button type="button" class="btn btn-danger remove-item" data-index="${index}">Eliminar</button></td>
                `;
                itemsContainer.appendChild(row);
            });
            
            // Agregar event listeners a los inputs
            itemsContainer.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    const value = field === 'description' ? this.value : parseFloat(this.value);
                    
                    currentQuote.items[index][field] = value;
                    
                    // Actualizar subtotal del ítem
                    if (field !== 'description') {
                        const subtotalCell = this.closest('tr').querySelector('.item-subtotal');
                        subtotalCell.textContent = (currentQuote.items[index].quantity * currentQuote.items[index].price).toFixed(2);
                    }
                    
                    updateQuoteTotals();
                });
            });
            
            // Agregar event listeners a los botones de eliminar
            itemsContainer.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    currentQuote.items.splice(index, 1);
                    loadQuoteItems();
                });
            });
            
            updateQuoteTotals();
        }

        // Actualizar totales de cotización
        function updateQuoteTotals() {
            if (!currentQuote) return;
            
            currentQuote.subtotal = currentQuote.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            currentQuote.tax = currentQuote.subtotal * 0.16; // 16% IVA
            currentQuote.total = currentQuote.subtotal + currentQuote.tax;
            
            document.getElementById('quoteSubtotal').textContent = currentQuote.subtotal.toFixed(2);
            document.getElementById('quoteTax').textContent = currentQuote.tax.toFixed(2);
            document.getElementById
